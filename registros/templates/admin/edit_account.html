{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
  <h1>Editar Cuenta: {{ account.name }}</h1>
  <form method="post" enctype="multipart/form-data" id="accountForm">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="button">Guardar</button>
  </form>

  <div class="row">
    <div class="col-md-8">
      <h2>Transacciones</h2>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Débito</th>
            <th>Crédito</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in account.transaction_set.all %}
            <tr>
              <td><a href="/registros/edit_entry/{{ transaction.entry.id }}">{{ transaction.entry.date }}</a></td>
              <td>{{ transaction.entry.description }}</td>
              <td>{{ transaction.debit }}</td>
              <td>{{ transaction.credit }}</td>
              <td>{{ transaction.get_balance }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-md-4">
      <h2>Adjuntos</h2>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Archivo</th>
            <th>Descripción</th>
          </tr>
        </thead>
        <tbody>
          {% for attachment in account.attachments.all %}
            <tr>
              <td><a href="{{ attachment.file.url }}" target="_blank">{{ attachment.file.name }}</a></td>
              <td>{{ attachment.description }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div id="dropArea" class="drop-area">
        Arrastra y suelta archivos aquí o haz clic para seleccionar archivos
        <input type="file" id="fileInput" multiple style="display: none;">
      </div>
    </div>
  </div>

  <style>
    .drop-area {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin-top: 20px;
      cursor: pointer;
    }
    .drop-area.dragover {
      border-color: #000;
      background-color: #f0f0f0;
    }
  </style>

  <!-- Cargar jQuery primero -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Bootstrap JS (optional, but needed for some features) -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');

    dropArea.addEventListener('click', () => fileInput.click());

    dropArea.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropArea.classList.add('dragover');
    });

    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dragover');
    });

    dropArea.addEventListener('drop', (event) => {
      event.preventDefault();
      dropArea.classList.remove('dragover');
      const files = event.dataTransfer.files;
      handleFiles(files);
    });

    fileInput.addEventListener('change', (event) => {
      const files = event.target.files;
      handleFiles(files);
    });

    function handleFiles(files) {
      const formData = new FormData();
      for (const file of files) {
        formData.append('files', file);
      }
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

      fetch("{% url 'upload_attachments' account.id %}", {
        method: 'POST',
        body: formData
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error al subir archivos');
          }
        });
    }
  </script>
{% endblock %}