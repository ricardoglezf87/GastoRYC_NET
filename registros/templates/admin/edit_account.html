{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
  <h1>Editar Cuenta</h1>
  <form method="post" enctype="multipart/form-data" id="accountForm">
    {% csrf_token %}
    {{ form.as_p }}
  </form>

  <div class="row">
    <div class="col-md-8">
      <h2>Transacciones</h2>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Débito</th>
            <th>Crédito</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in account.transaction_set.all %}
            <tr>
              <td><a href="/registros/edit_entry/{{ transaction.entry.id }}">{{ transaction.entry.date }}</a></td>
              <td>{{ transaction.entry.description }}</td>
              <td>{{ transaction.debit }}</td>
              <td>{{ transaction.credit }}</td>
              <td>{{ transaction.get_balance }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-md-4">
      <h2>Adjuntos</h2>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Archivo</th>
            <th>Descripción</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for attachment in account.attachments.all %}
            <tr data-attachment-id="{{ attachment.id }}">
              <td>
                <button type="button" class="btn btn-link" onclick="window.open('{{ attachment.file.url }}', '_blank')">
                  <i class="fas fa-paperclip"></i>
                </button>
              </td>
              <td contenteditable="true" class="editable-description">{{ attachment.description }}</td>
              <td>
                <button type="button" class="btn btn-danger btn-sm delete-attachment">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div id="dropArea" class="drop-area">
        Arrastra y suelta archivos aquí o haz clic para seleccionar archivos
        <input type="file" id="fileInput" multiple style="display: none;">
      </div>
    </div>
  </div>

  <style>
    .drop-area {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin-top: 20px;
      cursor: pointer;
    }
    .drop-area.dragover {
      border-color: #000;
      background-color: #f0f0f0;
    }
  </style>

  <!-- Cargar jQuery primero -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Bootstrap JS (optional, but needed for some features) -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');

    dropArea.addEventListener('click', () => fileInput.click());

    dropArea.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropArea.classList.add('dragover');
    });

    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dragover');
    });

    dropArea.addEventListener('drop', (event) => {
      event.preventDefault();
      dropArea.classList.remove('dragover');
      const files = event.dataTransfer.files;
      handleFiles(files);
    });

    fileInput.addEventListener('change', (event) => {
      const files = event.target.files;
      handleFiles(files);
    });

    function handleFiles(files) {
      const formData = new FormData();
      for (const file of files) {
        formData.append('files', file);
      }
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

      fetch("{% url 'upload_attachments' account.id %}", {
        method: 'POST',
        body: formData
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error al subir archivos');
          }
        });
    }

    // Funcionalidad para editar la descripción
    document.querySelectorAll('.editable-description').forEach(cell => {
      cell.addEventListener('blur', function() {
        const attachmentId = this.closest('tr').dataset.attachmentId;
        const description = this.textContent.trim();
        fetch(`/registros/update_attachment_description/${attachmentId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ description })
        }).then(response => response.json())
          .then(data => {
            if (!data.success) {
              alert('Error al actualizar la descripción');
            }
          });
      });
    });

    // Funcionalidad para borrar adjuntos
    document.querySelectorAll('.delete-attachment').forEach(button => {
      button.addEventListener('click', function() {
        const row = this.closest('tr');
        const attachmentId = row.dataset.attachmentId;
        if (confirm('¿Estás seguro de que deseas eliminar este adjunto?')) {
          fetch(`/registros/delete_attachment/${attachmentId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          }).then(response => response.json())
            .then(data => {
              if (data.success) {
                row.remove();
              } else {
                alert('Error al eliminar adjunto');
              }
            });
        }
      });
    });

    // Guardado automático del formulario
    $('#accountForm').on('change', 'input, select', function() {
      const formData = new FormData($('#accountForm')[0]);
      fetch("{% url 'edit_account' account.id %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      }).then(response => response.json())
        .then(data => {
          if (!data.success) {
            alert('Error al guardar los cambios');
          }
        });
    });
  </script>
{% endblock %}