{% extends "admin/base_site.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block header %}
    {{ block.super }}
    {# --- Tus otros links y scripts --- #}
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap4.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/dataTables.editor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.3.1/luxon.min.js"></script>

    <script>
        $(document).ready(function() {
            // --- Script para Crear Backup (existente) ---
            $('#create-backup-link').on('click', function(event) {
                event.preventDefault();
                var $link = $(this);
                var originalText = $link.text();
                $link.text('Creando copia...');
                $link.css('pointer-events', 'none');
                $link.css('opacity', '0.6');

                $.ajax({
                    url: $link.attr('href'), 
                    type: 'GET',
                    success: function(response) {
                        alert('¡Copia de seguridad iniciada/creada exitosamente!');
                    },
                    error: function(xhr, status, error) {
                        console.error("Error al crear backup:", status, error, xhr.responseText);
                        alert('Error al crear la copia de seguridad.');
                    },
                    complete: function() {
                        $link.text(originalText);
                        $link.css('pointer-events', 'auto');
                        $link.css('opacity', '1');
                         }
                });
            });

            // --- NUEVO Script para Recalcular Saldos ---
            $('#recalculate-balances-link').on('click', function(event) {
                event.preventDefault();
                var $link = $(this);
                var originalText = $link.text();
                $link.text('Creando copia...');
                $link.css('pointer-events', 'none');
                $link.css('opacity', '0.6');

                $.ajax({
                    url: $link.attr('href'), 
                    type: 'GET',
                    success: function(response) {
                        alert('¡Saldos iniciales creados/actualizados exitosamente!');
                    },
                    error: function(xhr, status, error) {
                        console.error("Error al crear saldos iniciales:", status, error, xhr.responseText);
                        alert('Error al crear saldos iniciales.');
                    },
                    complete: function() {
                        $link.text(originalText);
                        $link.css('pointer-events', 'auto');
                        $link.css('opacity', '1');
                         }
                });
            });
        });


        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken'); // Obtener el token CSRF globalmente

    // Función genérica para enviar datos POST como JSON usando Fetch API
    async function postData(url = '', data = {}) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken // Usar el token CSRF obtenido globalmente
                },
                body: JSON.stringify(data)
            });

            // Intenta parsear la respuesta como JSON, incluso si no es 'ok'
            // para obtener mensajes de error del backend si los hay.
            const responseData = await response.json().catch(() => ({})); // Devuelve {} si no es JSON válido

            if (!response.ok) {
                // Si la respuesta no es OK, construye un mensaje de error
                // Prioriza el mensaje del backend si existe
                const errorMessage = responseData.message || `Error ${response.status}: ${response.statusText}`;
                throw new Error(errorMessage);
            }

            // Si la respuesta es OK, devuelve los datos (puede incluir mensajes de éxito)
            return responseData;

        } catch (error) {
            // Captura errores de red o errores lanzados arriba
            console.error('Error en postData:', error);
            // Re-lanza el error para que sea capturado por el .catch() en la llamada original
            throw error;
        }
    }

    // Función para recargar la página manteniendo los parámetros GET actuales
    function reloadWithFilters() {
        // Obtiene los parámetros GET de la URL actual
        const searchParams = window.location.search;
        // Recarga la página con la misma ruta y los mismos parámetros
        window.location.href = window.location.pathname + searchParams;
    }

    </script>

    {# --- Estilos adicionales si son necesarios para el dropdown --- #}
    <style>
        /* Ajusta el espaciado o apariencia si es necesario */
        #user-tools .dropdown {
            margin-left: 10px; /* Ejemplo de espaciado */
        }
        #user-tools .dropdown-toggle::after {
             margin-left: .255em; /* Ajuste del icono de flecha de Bootstrap */
        }
        
        /* Asegura que los enlaces dentro del dropdown se vean bien */
        .dropdown-item {
            color: #333 !important; /* O el color que prefieras */
            padding: .5rem 1.5rem;
        }
        .dropdown-item:hover {
            background-color: #f8f9fa; /* Color de fondo al pasar el ratón */
        }

        .nav-global-dropdown {
            display: inline-block;
            vertical-align: middle; /* Puede ayudar a alinear con otros enlaces */
            margin-left: 15px; /* Ajusta según necesites */
        }
    </style>

{% endblock %}

{% block nav-global %}
    {# Mantenemos los enlaces rápidos existentes si quieres #}
    <a href="/accounts/add_account/">Nueva cuenta</a>
    <a href="/entries/add_entry/">Nueva entrada</a>
    <a href="/bank_imports/import_movements/">Importar movimientos</a>

    <div class="dropdown nav-global-dropdown" style="display: inline-block;">
        <a class="nav-link dropdown-toggle" href="#" id="reportsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-chart-bar mr-1"></i> Reportes y Limpieza 
        </a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="reportsDropdown">
            {# Asegúrate que las URLs sean correctas o usa {% url 'app_name:url_name' %} #}
            <a class="dropdown-item" href="/reports/unbalanced_entries/"> {# Asumiendo que 'unbalanced_entries' está en la app 'report' #}
                <i class="fas fa-balance-scale-left mr-2"></i>Movimientos Descuadrados
            </a>
            <a class="dropdown-item" href="/reports/merge_transactions/">
                <i class="fas fa-compress-arrows-alt mr-2"></i>Unificar Transacciones
            </a>
            <a class="dropdown-item" href="/reports/detect_transfers/">
                <i class="fas fa-exchange-alt mr-2"></i>Simplificar Transferencias
            </a>
            <a class="dropdown-item" href="/reports/delete_empty_entries/">
                <i class="fas fa-trash-alt mr-2"></i>Eliminar Asientos Vacíos
            </a>
        </div>
    </div>
	
    <div class="dropdown nav-global-dropdown" style="display: inline-block;">
        <a class="nav-link dropdown-toggle" href="#" id="optionsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Opciones
        </a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="optionsDropdown">
            <a class="dropdown-item" href="/async/create_backup" id="create-backup-link">
                <i class="fas fa-save mr-2"></i>Crear Copia Seguridad
            </a>
            <a class="dropdown-item" href="/async/calculate_inicial_balances" id="recalculate-balances-link">
                <i class="fas fa-calculator mr-2"></i>Recalcular Saldos
            </a>
        </div>
    </div>
    {# Fin del Menú Desplegable #}

{% endblock %}

{% block branding %}
    <h1 id="site-name">
        <a href="/accounts/account_tree/">
            <img src="{% static 'img/logo.png' %}" alt="GARCA Logo" style="max-height: 40px;">
        </a>
    </h1>
{% endblock %}

{% block nav-breadcrumbs %}
    {% if not is_popup %}
    <div class="breadcrumbs">
        <a href="/accounts/account_tree/">Home</a>
        {% for breadcrumb_text, breadcrumb_url in breadcrumbs %}
        &rsaquo; <a href="{{ breadcrumb_url }}">{{ breadcrumb_text }}</a>
        {% endfor %}
    </div>
    {% endif %}
{% endblock %}
